<!DOCTYPE html>
<html lang="en">
    
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial=scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
        <link rel="stylesheet" type="text/css" href="style.css">
        <style>
            input {
            width: 300px;
            padding: 8px;
            margin-bottom: 20px;
    }
    #results {
      font-family: sans-serif;
      margin-top: 20px;
    }
        </style>
    </head>

    <input id="HawksRidgeBtn" type="button" value="GetZillowValue" onclick="RunZillow();" />
    <h1 id="display"></h1>
             
    </div>

    <script type="text/javascript">
        const apiURL = "https://api.bridgedataoutput.com/api/v2/zestimates_v2/zestimates?access_token=449866bf79a548efd5cfc5bc544a19e0";
        const NewURL = apiURL + "&zpid=" + "230892001";
        const outputDiv = document.getElementById('display');
        var ZillowReturn;

        function RunZillow() {
            //console.log("Before we add the URL together...");
            //var toCall = apiURL + "&zpid=" + "230892001";
            //console.log('The URL we will call now... '+ toCall);
            fetch(NewURL).then(function(response) {
            //document.getElementById('functionResult').innerHTML = response.json();
            return response.text();
            }).then(function(data) {
            
            ZillowReturn = SplitStringZestimate(data);
            console.log("The Value is ..." + ZillowReturn);
            const prop = SplitStringPropertyName(data);
            console.log("The property name is ..." + prop);
            }).catch(function(err) {
            console.log('Fetch Error :-S', err);
            });

            return ZillowReturn;
        }

        function SplitStringZestimate(data) {
            const str = data;
            //console.log("The data is....")
            //console.log(data)
            const split1 = data.split("zestimate");
            //console.log("Attempt to split the Zestimate value")
            //console.log(split1);
            

            const InitialZest = split1[1];
            //console.log("Initial Zest is...")
            //console.log(InitialZest)

            constRemoveChars = InitialZest.split(":")
            //console.log("ConstRemoveChars1 is ....")
            //console.log(constRemoveChars[1])

            const FinalZest = constRemoveChars[1].split(",")
            //console.log(FinalZest[0])
            const outputData = FinalZest[0];
            outputDiv.textContent = outputData;

            return outputData;
        }

        function SplitStringPropertyName(data) {
            var PropertySplit1 = data.split("address");
            //console.log("Initial Property Split is...");
            //console.log(PropertySplit1);

            const PropertySplit2 = PropertySplit1[1].split(",");
            //console.log("2nd Property Split is...");
            //console.log(PropertySplit2);

            const PropertySplit3 = PropertySplit2[0];
            //console.log("3rd Property Split is...");
            //console.log(PropertySplit3);

            var PropertySplit4 = PropertySplit3.split(":")[1];
            //console.log("4th Property Split is...");
            //console.log(PropertySplit4);

            var outData = PropertySplit4.split('"')[1];
            //console.log("5th Property Split is...");
            //console.log(outData);

            return outData;

        }

        function addRow(propName) {
            const table = document.getElementById("myTable").getElementsByTagName('tbody')[0];

            const newRow = table.insertRow();

            const nameCell = newRow.insertCell();
            nameCell.textContent = propName;
            
            const ageCell = newRow.insertCell();
            ageCell.textContent = RunZillow();

            console.log("Now running Zillow!..." + RunZillow());
        }

        function LoadData() {
            
        }

        function autoFill() {
            // Run the autocomplete API request
            var requestOptions = {
                method: 'GET',
            };

            const input = document.getElementById('myInput');
            const thisStr = input.value;
            var inputScrub = replaceSpaces(thisStr);
            //inputScrub = '"'+inputScrub+'"';
            console.log("this is my scrubbed string:  " + inputScrub);
            
            console.log("This is my input.value:" + inputScrub.value);
            const stringBuilder = "https://api.geoapify.com/v1/geocode/autocomplete?text=";
            const APIstr = "634d8a64c241417086d6e4540e1a984f";
            const toCall = stringBuilder + inputScrub + "&apiKey=" + APIstr;
            console.log("This is my to call:    " + toCall);
            
            console.log("My input is.... " + inputScrub);
            let fetchStr = toCall;
            console.log("My fetch is.... " + fetchStr);

            fetch(fetchStr, requestOptions)
            .then(response => response.json())
            .then(data => {
                // Process the data;
                let myData = JSON.stringify(data);
                console.log("Here is my data in string form..." + myData);
                const adr = myData.split("address_line1")[0];
                const sp = adr.split("formatted");
                console.log("My address is..." + sp)[1];
            })
            .catch(error => console.log('error', error));

            // Show a list of candidate properties
        }

        function replaceSpaces(str) {
            console.log(str);
            return str.replace(/ /g, '%20');
        }

        function MoveData() {
            fetch('http://localhost:3000/api/users')
            .then(res => res.json())
            .then(users => {
            console.log(users); // You can render this data on your page
            })
            .catch(err => {
                console.error('Error fectching users:', err);
            });
        }
    </script>

    <body onload="LoadData()">

        <table id="myTable" class="bordered" style="width: 500px">
            <thead>
              <tr>
                <th>Property</th>
                <th>Zestimate Value</th>
              </tr>
            </thead>
            <tbody>
              <!-- Rows will be added here -->
            </tbody>
          </table>
          
        <button onclick="addRow('123 Hawks Ridge')">Add Row</button>
          
        <table class="bordered" style="width: 100%">
            <tr>
                <td>Property</td>
                <td>Zestimate Value</td>
            </tr>
        </table>

        <button onclick="MoveData()">Move Data from Server</button>

        <h2 for="myInput">Property Search</h2>
  
  <input type="text" list="inputs" id="myInput" oninput="autoFill()" placeholder="Search for an address..."/>
  <datalist id="inputs">
    <option value="Test1"></option>
    <option value="Test2"></option>
    <option value="Test3"></option>
  </datalist> 

  <script>
    // Replace with your actual API keys
    const geoapifyApiKey = '634d8a64c241417086d6e4540e1a984f'; // Geoapify API key
    const zillowApiKey = '449866bf79a548efd5cfc5bc544a19e0';    // Zillow API key

    // Initialize Geoapify Autocomplete
    const input = document.getElementById('autocomplete');
    //const autocomplete = new geoapify.Autocomplete(input, {
    //  apiKey: geoapifyApiKey
    //});

    // Handle address selection and fetch property details from Zillow
    /* autocomplete.on('select', async (e) => {
      const address = e.result.properties.formatted;
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = 'üîÑ Fetching property data from Zillow...';

      try {
        // Zillow API endpoint (use your key)
        const zillowEndpoint = `https://api.zillow.com/webservice/GetDeepSearchResults.htm?zws-id=${zillowApiKey}&address=${encodeURIComponent(address)}&citystatezip=${encodeURIComponent('Austin, TX')}`;

        const res = await fetch(zillowEndpoint);
        const xmlText = await res.text();
        
        if (res.ok) {
          const parser = new DOMParser();
          const xmlDoc = parser.parseFromString(xmlText, "text/xml");
          
          const property = xmlDoc.getElementsByTagName("response")[0]?.getElementsByTagName("results")[0];
          const homeDetails = property ? {
            homeType: property.getElementsByTagName("useCode")[0]?.textContent || 'N/A',
            price: property.getElementsByTagName("amount")[0]?.textContent || 'N/A',
            yearBuilt: property.getElementsByTagName("yearBuilt")[0]?.textContent || 'N/A',
            squareFeet: property.getElementsByTagName("finishedSqFt")[0]?.textContent || 'N/A',
            zestimate: property.getElementsByTagName("zestimate")[0]?.getElementsByTagName("amount")[0]?.textContent || 'N/A'
          } : {};

          // Display the property details
          if (homeDetails) {
            resultsDiv.innerHTML = `
              <strong>Home Type:</strong> ${homeDetails.homeType}<br>
              <strong>Price:</strong> $${homeDetails.price}<br>
              <strong>Year Built:</strong> ${homeDetails.yearBuilt}<br>
              <strong>Square Feet:</strong> ${homeDetails.squareFeet} sq ft<br>
              <strong>Zestimate:</strong> $${homeDetails.zestimate}
            `;
          } else {
            resultsDiv.innerHTML = '‚ùå Property data not found.';
          }
        } else {
          resultsDiv.innerHTML = '‚ùå Error fetching property data from Zillow.';
        }
      } catch (error) {
        console.error(error);
        resultsDiv.innerHTML = '‚ùå Error fetching property data.';
      }
    }); */
  </script>

    </body>

</html>



