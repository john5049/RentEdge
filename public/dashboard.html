<!DOCTYPE html>
<html>
<head>
  <title>RentWise</title>
  <link rel="icon" href="/icons8-house-32.png" type="image/x-icon"/>
</head>
<style>
  body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f5f7fa;
      margin: 0;
      padding: 0;
    }

    .navbar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background-color: #4CAF50; /* Green navbar */
  padding: 10px 20px;
  color: white;
  font-size: 20px;
}

.navbar-left {
  font-weight: bold;
}

.navbar-right {
  position: relative;
}

.dropdown {
  position: relative;
  display: inline-block;
}

.dropbtn {
  background-color: #4CAF50;
  color: white;
  font-size: 16px;
  border: none;
  cursor: pointer;
  padding: 10px;
  border-radius: 8px;
}

.dropbtn:hover {
  background-color: #45a049;
}

.dropdown-content {
  display: none;
  position: absolute;
  right: 0;
  background-color: white;
  min-width: 160px;
  box-shadow: 0px 8px 16px rgba(0,0,0,0.2);
  z-index: 1;
  border-radius: 8px;
  overflow: hidden;
}

.dropdown-content a,
.dropdown-content .logout-link {
  display: block;
  width: 100%;
  padding: 12px 16px;
  text-align: left;
  text-decoration: none;
  background: none;
  border: none;
  color: black;
  font-size: 16px;
  font-family: inherit;
  cursor: pointer;
}

.dropdown-content a:hover,
.dropdown-content .logout-link:hover {
  background-color: #f1f1f1;
}

.dropdown:hover .dropdown-content {
  display: block;
}

.logout-link {
  background: none;
  font-size: 16px;
}

.dashboard-container {
  max-width: 100%;
  margin: 0px auto;
  padding: 40px;
  background-color: #fff;
  border-radius: 12px;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
  text-align: center;
  
}

.dashboard-layout {
display: flex;
  flex-wrap: wrap; /* ‚úÖ allow children to stack */
  gap: 20px;        /* better spacing */
  padding: 20px;
}

.properties-container {
  flex: 1;
  max-height: 600px; /* Example height */
  overflow-y: auto;
  border: 1px solid #ccc;
  padding: 10px;
  border-radius: 10px;
}
.analytics-container {
  flex: 1 1 100%; /* ‚úÖ grow and shrink; take full width on small screens */
  max-height: 600px;
  overflow-y: auto;
  border: 1px solid #ccc;
  padding: 10px;
  border-radius: 10px;
  box-sizing: border-box;
}

    /* Custom Scrollbar Styling */
    .properties-container::-webkit-scrollbar,
    .analytics-container::-webkit-scrollbar {
      width: 15px;
    }

    .properties-container::-webkit-scrollbar-track,
    .analytics-container::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }

    .properties-container::-webkit-scrollbar-thumb,
    .analytics-container::-webkit-scrollbar-thumb {
      background-color: #000000;
      border-radius: 10px;
      border: 2px solid #f1f1f1;
    }

    .properties-container::-webkit-scrollbar-thumb:hover,
    .analytics-container::-webkit-scrollbar-thumb:hover {
      background-color: #45a049;
      cursor: pointer;
    }

    .properties-container {
      max-width: 900px;
      margin: 60px auto;
      padding: 40px;
      background-color: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      text-align:center;
      max-height: 500px;
      overflow-y:scroll;
    }

    .analytics-container {
      max-width: 40%;
      margin: 60px;
      padding: 40px;
      background-color: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      text-align: center;
      max-height: 500px;
      overflow-y:scroll;
    }

    h1 {
      font-size: 32px;
      color: #333;
      margin-bottom: 20px;
    }

    p {
      font-size: 18px;
      color: #555;
    }

    .logout-button {
      margin-top: 30px;
      padding: 12px 24px;
      font-size: 16px;
      background-color: #FF9AA2;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    .logout-button:hover {
      background-color: #FF9AA2;
    }
</style>


<body>
  <!-- <h1>RENT WISE Dashboard</h1> -->
    <div class="navbar">
      <div class="navbar-left">
        üè† RentWise 
      </div>
      <div class="navbar-right">
        <div class="dropdown">
          <button class="dropbtn">Menu ‚ñæ</button>
          <div class="dropdown-content">
            <a href="/settings.html">Settings</a>
            <form id="logout-form" action="/logout" method="GET" style="margin: 0;">
              <button type="submit" class="logout-link">Logout</button>
            </form>
          </div>
        </div>
      </div>
    </div>
   <div class="dashboard-container">
    
    
    <h1 style="font-size: 40px;">Welcome to your Dashboard</h1>
    
    <p id="welcome-message">Hello, </p>

    <!-- <form action="/logout" method="GET">
      <button type="submit" class="logout-button">Logout</button>
    </form> -->
   </div>
  <!-- <p id="welcome-message" style="color: blue; font-style: italic; font-weight: bold; font-size: 18px;"></p> -->
<div class="dashboard-layout">
  <div class="properties-container">
    <h1>Properties</h1>
    <!-- Add property form -->
    <input type="text" id="autocomplete-input" placeholder="Enter property address..." style="padding: 10px; width: 60%; border-radius: 8px; border: 1px solid #ccc;">
    <button onclick="addProperty()" style="padding: 10px 20px; margin-left: 10px; border-radius: 8px; background-color: #4CAF50; color: white; border: none; cursor: pointer;">‚ûï Add Property</button>
    <input type="file" id="file-upload" style="display: none;" accept=".csv, .xlsx, .xls" />
    <button onclick="document.getElementById('file-upload').click()" class="upload-file-button" style="padding: 10px 20px; margin-left: 10px; border-radius: 8px; background-color: #e3c681; color: white; border: none; cursor: pointer;">üìÅ Upload File</button>

    <ul id="suggestions" style="list-style: none; padding: 0; margin-top: 10px;"></ul>

    <h3 style="margin-top: 30px;">My Properties</h3>
    <!-- Where properties will be listed -->
    <ul id="property-list" style="list-style: none; padding: 0; margin-top: 20px;"></ul>
   </div>

   <div class="analytics-container">
    <h1>Market Valuation</h1>
    <ul id="analytics-list" style="list-style: none; padding: 0;"></ul>
   </div>
</div>
   
  <script>
    const username = sessionStorage.getItem('userName');
    const userId = sessionStorage.getItem('userId');

    const client_id = 'JVa1jJ4an57MEsyxFhTZZ2uKCi22aElruLuMD9fqM8JpDhGg';
    const client_secret = 'QsCXM36RhZ0KrjxuXtWfZ515KMqRRRtVM0FAZqmtnkJeSJGbw5UPT8U9CYiFhZto';

    const token = null;

    if (!userId) {
      // No login found ‚Äî redirect back to login
      window.location.href = '/login.html';
    } else {
      document.getElementById('welcome-message').innerHTML =
  `<span style="font-size: 24px;">Hello, ${username} welcome back to <strong style="color: green;">RentWise</strong>. We're glad you're here!</span>`;
        loadProperties();
    }

    const input = document.getElementById("autocomplete-input");
    const suggestionsList = document.getElementById("suggestions");
    const propertyList = document.getElementById("property-list");

    const apiKey = "634d8a64c241417086d6e4540e1a984f"; // your Geoapify API key

    async function loadProperties() {
      try {
    const response = await fetch(`/properties?userId=${userId}`);
    const properties = await response.json();

    propertyList.innerHTML = '';
    const analyticsList = document.getElementById('analytics-list');
    analyticsList.innerHTML = '';

    for (const property of properties) {
      const listItem = document.createElement('li');
      listItem.style.padding = '8px';
      listItem.style.borderBottom = '1px solid #eee';
      listItem.style.display = 'flex';
      listItem.style.justifyContent = 'space-between';
      listItem.style.alignItems = 'center';

      const addressSpan = document.createElement('span');
      addressSpan.textContent = property.propertyAddress;

      addressSpan.style.flex = '1';

const editBtn = document.createElement('button');
editBtn.textContent = 'Edit';
editBtn.style.marginLeft = '10px';
editBtn.style.backgroundColor = '#C7CEEA';
editBtn.style.color = 'white';
editBtn.style.border = 'none';
editBtn.style.borderRadius = '5px';
editBtn.style.padding = '5px 10px';
editBtn.style.cursor = 'pointer';

let isEditing = false;

editBtn.onclick = async () => {
  if (!isEditing) {
    const input = document.createElement('input');
    input.type = 'text';
    input.value = property.propertyAddress;
    input.style.flex = '1';
    listItem.replaceChild(input, addressSpan);
    editBtn.textContent = 'Save';
    isEditing = true;
  } else {
    const newAddress = listItem.querySelector('input').value.trim();
    if (!newAddress) {
      alert("Address cannot be empty");
      return;
    }

    // Try to get new zpid (or retain existing one)
    let zpid = await fetchZpid(newAddress);
    if (!zpid) {
      zpid = prompt(`We couldn't find the ZPID for '${property}'. Please enter the ZPID manually:`);
      if (!zpid) return;
    }

    const response = await fetch('/update-property', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        id: property.id,
        userId,
        propertyAddress: newAddress,
        zpid
      })
    });

    if (response.ok) {
      loadProperties();
    } else {
      alert("Failed to update property");
    }
  }
};

      const deleteBtn = document.createElement('button');
      deleteBtn.textContent = 'Delete';
      deleteBtn.style.marginLeft = '10px';
      deleteBtn.style.backgroundColor = '#FF9AA2';
      deleteBtn.style.color = 'white';
      deleteBtn.style.border = 'none';
      deleteBtn.style.borderRadius = '5px';
      deleteBtn.style.padding = '5px 10px';
      deleteBtn.style.cursor = 'pointer';

      deleteBtn.onclick = async () => {
        if (confirm('Are you sure you want to delete this property?')) {
          await deleteProperty(property.id);
          loadProperties();
        }
      };

      listItem.appendChild(addressSpan);
      listItem.appendChild(deleteBtn);
      listItem.appendChild(editBtn);
      propertyList.appendChild(listItem);

      // NEW: Fetch Zestimate and Rent Zestimate using the zpid
      if (property.zpid) {
        const zillowData = await fetchZillowData(property.zpid);
        console.log('Here is my zillow data' + zillowData);
        if (zillowData) {
          const analyticsItem = document.createElement('li');
          analyticsItem.style.padding = '8px';
          analyticsItem.style.borderBottom = '1px solid #eee';
          analyticsItem.innerHTML = `
            <strong>${property.propertyAddress}</strong><br>
            Zestimate: <span style="color: green;">$${zillowData.zestimate}</span><br>
            Rent Zestimate: <span style="color: blue;">$${zillowData.rentalZestimate}</span>
          `;
          analyticsList.appendChild(analyticsItem);
        }
      }
    }
  } catch (error) {
    console.error('Error loading properties:', error);
  }
}

document.addEventListener('DOMContentLoaded', function () {
    token = getAccessToken();
  });

document.getElementById('file-upload').addEventListener('change', function(e) {
    const file = e.target.files[0];
    console.log(file);
    if (!file) return;

    const reader = new FileReader();

    reader.onload = function(event) {
      const text = event.target.result;
      processCSV(text);
    };

    reader.readAsText(file);
  });

  // Get OAuth token
  async function getAccessToken() {
  const res = await fetch('https://apis.usps.com/oauth2/v3/token', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      client_id,
      client_secret,
      grant_type: 'client_credentials'
    })
  });

  const data = await res.json();

  if (!res.ok || !data.access_token) {
    throw new Error(`Failed to get token: ${JSON.stringify(data)}`);
  }

  console.log('‚úÖ Access token received');
  return data.access_token;
}

// Validate address
async function validateAddress(token, {streetAddress, city, state}) {
  const params = new URLSearchParams({
    streetAddress : streetAddress,
    city: city,
    state: state
  });

  const res = await fetch(`https://apis.usps.com/addresses/v3/address?${params.toString()}`, {
    method: 'GET',
    headers: {
      'Authorization': `Bearer ${token}`
    }
  });

  const data = await res.json();

  if (!res.ok) {
    throw new Error(`Address API failed: ${JSON.stringify(data)}`);
  }

  return data;
}

  async function processCSV(text) {
    const lines = text.trim().split('\n');
    const header = lines[0].split(',');

    // Find the index of the 'Property' column
    const propertyIndex = header.findIndex(col => col.trim().toLowerCase() === 'property');

    if (propertyIndex === -1) {
      console.error("No 'Property' column found in the CSV.");
      return;
    }

    // Loop through each row (starting from the second line)
    for (let i = 1; i < lines.length; i++) {
      const row = lines[i].split(',');
      let property = row[propertyIndex]?.trim();

      if (property) {
        property = property.replace(/^"|"$/g, '');
        console.log(`Property: ${property}`);
        
        try {
      let zpid = await fetchZpid(property);

      if (!zpid) {
        // If zpid fetching failed, prompt the user
        zpid = prompt(`We couldn't find the ZPID for '${property}'. Please enter the ZPID manually:`);

        // If user cancels or doesn't enter anything
        if (!zpid) {
          alert("Property addition canceled. A ZPID is required to add a property.");
          return; // Stop the function
        }
      }

      console.log("Using ZPID:", zpid);

      // Save the property to the backend database
      const response = await fetch('/properties', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          propertyAddress: property,
          userId: userId,
          zpid: zpid
        })
      });

      if (response.ok) {
        console.log("Property added to the database successfully!");
        input.value = '';
        await loadProperties();
      } else {
        throw new Error("Failed to add property to the database");
      }
    } catch (error) {
      console.error("Error in addProperty function:", error);
      alert("There was an error adding the property. Please try again.");
    }

        // You would call your ZPID-fetching function here:
       /*  fetchZpid(property).then(zpid => {
          console.log(`ZPID for ${property}:`, zpid);
          // Add each property to My Properties list
          console.log(property + '_' + userId + '_' + zpid);
          // Save the property to the backend database
          const response = fetch('/properties', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              propertyAddress: property,
              userId: userId,
              zpid: zpid
            })
          });

          console.log(response);

          if (response.ok) {
            console.log("Property added to the database successfully!");
            input.value = '';
            loadProperties();
          } else {
            throw new Error("Failed to add property to the database");
          }

            }).catch(err => {
              console.error(`Failed to get ZPID for ${property}`, err);
            }); */
          }
  }
  }

    input.addEventListener("input", async () => {
    const query = input.value;
    if (query.length < 3) {
      suggestionsList.innerHTML = "";
      return;
    }

    const response = await fetch(`https://api.geoapify.com/v1/geocode/autocomplete?text=${encodeURIComponent(query)}&limit=10&apiKey=${apiKey}`);
    const data = await response.json();

    suggestionsList.innerHTML = "";
    data.features.forEach(feature => {
      const li = document.createElement("li");
      li.textContent = feature.properties.formatted;
      li.style.padding = "8px";
      li.style.cursor = "pointer";
      li.style.borderBottom = "1px solid #eee";
      li.onclick = () => {
        input.value = feature.properties.formatted;
        suggestionsList.innerHTML = "";
        suggestionsList.style.display = "none";
      };
      suggestionsList.appendChild(li);
    });
    if (data.features.length > 0) {
    suggestionsList.style.display = "block"; // Show suggestions box
  } else {
    suggestionsList.style.display = "none"; // Hide if no results
  }
  });

  document.addEventListener("click", (event) => {
  if (!suggestionsList.contains(event.target) && event.target !== input) {
    suggestionsList.style.display = "none"; // Hide suggestions when clicking outside
  }
});

  // Fetch Zillow API data - rent Zestimate and Zestimate
  async function fetchZillowData(zpid) {
  try {
    const zillowAPIurl = `https://api.bridgedataoutput.com/api/v2/zestimates_v2/zestimates?access_token=449866bf79a548efd5cfc5bc544a19e0&zpid=${zpid}`;
    console.log(zillowAPIurl);
    const response = await fetch(zillowAPIurl);
    if (!response.ok) {
      throw new Error(`Failed to fetch Zillow data: ${response.status}`);
    }
    const data = await response.json();
    // Assuming your server sends back something like { zestimate: 500000, rentZestimate: 2500 }
    
    if (data && data.bundle && data.bundle.length > 0) {
      const firstResult = data.bundle[0];
      const zestimate = firstResult.zestimate;
      const rentalZestimate = firstResult.rentalZestimate;

      console.log("Zestimate:", zestimate);
      console.log("Rental Zestimate:", rentalZestimate);

      return { zestimate, rentalZestimate };
    } else {
      console.error("No Zestimate data found for this ZPID.");
      return null;
    }
  } catch (error) {
    console.error("Error fetching Zestimate:", error);
    return null;
  }
}

  async function addProperty() {
    const propertyAddress = input.value.trim();
    consol.log('My property address is: ' + propertyAddress);

  if (propertyAddress) {
    try {
      let zpid = await fetchZpid(propertyAddress);

      if (!zpid) {
        // If zpid fetching failed, prompt the user

        // Instead of prompting user to input the ZPID, let's see if the USPS API can provide the correct address.
        const uspsAdr = await validateAddress(token, propertyAddress);

        //zpid = prompt("We couldn't find this property automatically. Please enter the ZPID manually:");

        // If user cancels or doesn't enter anything
        if (!zpid) {
          alert("Property addition canceled. A ZPID is required to add a property.");
          return; // Stop the function
        }
      }

      console.log("Using ZPID:", zpid);

      // Save the property to the backend database
      const response = await fetch('/properties', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          propertyAddress: propertyAddress,
          userId: userId,
          zpid: zpid
        })
      });

      if (response.ok) {
        console.log("Property added to the database successfully!");
        input.value = '';
        await loadProperties();
      } else {
        throw new Error("Failed to add property to the database");
      }
    } catch (error) {
      console.error("Error in addProperty function:", error);
      alert("There was an error adding the property. Please try again.");
    }
  }
}

// Function to check if it's day or night
function setDayOrNightIcon() {
    const hour = new Date().getHours(); // Gets local hour (0‚Äì23)
    const iconContainer = document.getElementById('day-icon');

    if (hour >= 6 && hour < 18) {
      iconContainer.textContent = "‚òÄÔ∏è"; // Daytime
    } else {
      iconContainer.textContent = "üåô"; // Nighttime
    }
  }

  setDayOrNightIcon();

// Function to create a property list item with a delete button
function createPropertyListItem({ propertyAddress, zpid }) {
  const listItem = document.createElement('li');
  listItem.textContent = `${propertyAddress} (zpid: ${zpid})`;
  listItem.style.padding = '8px';
  listItem.style.borderBottom = '1px solid #eee';

  // Create the delete button
  const deleteButton = document.createElement('button');
  deleteButton.textContent = 'Delete';
  deleteButton.style.marginLeft = '10px';
  deleteButton.style.padding = '5px 10px';
  deleteButton.style.backgroundColor = '#ff9aa2';
  deleteButton.style.color = 'white';
  deleteButton.style.border = 'none';
  deleteButton.style.borderRadius = '5px';
  deleteButton.style.cursor = 'pointer';

  // Attach the delete functionality
  /* deleteButton.addEventListener('click', async (event) => {
    event.stopPropagation(); // Prevent the event from bubbling up to the parent

    try {
      const response = await fetch('/delete-property', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          propertyAddress: propertyAddress,
          userId: userId,
          zpid: zpid
        })
      });

      if (!response.ok) {
        throw new Error('Failed to delete property');
      }

      // Remove the list item from the DOM
      listItem.remove();
    } catch (error) {
      console.error('Error deleting property:', error);
    }
  }); */

  listItem.appendChild(deleteButton);
  return listItem;
  }

  // Function to grab zpid from API
  async function fetchZpid(address) {
    const addrWithoutCountry = removeCountryFromAddress(address);
    const apiUrl = `https://api.bridgedataoutput.com/api/v2/pub/parcels?access_token=449866bf79a548efd5cfc5bc544a19e0&address.full=${encodeURIComponent(addrWithoutCountry)}`;
    console.log(apiUrl);
  
  try {
    const response = await fetch(apiUrl);
    
    // Check if the response is ok (status code 200)
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const data = await response.json();
    
    // Log the response data for debugging
    console.log("API Response:", data);
    
    // Ensure the data contains parcels and retrieve the first zpid from the response
    if (data && data.bundle && data.bundle.length > 0) {
      const zpid = data.bundle[0].zpid; // Assuming the first parcel has the desired zpid
      return zpid;
    } else {
      console.error("No parcels found for the provided address");
      return null;
    }
    
  } catch (error) {
    console.error("Error fetching zpid:", error);
    return null;
  }
  }

  function removeCountryFromAddress(address) {
  // List of country names to remove (you can expand this list as needed)
  const countries = ["USA", "United States", "United States of America", "Canada", "Mexico", "United Kingdom", "Australia"];
  
  // Iterate through the countries array and remove any match from the address
  let cleanedAddress = address;
  countries.forEach(country => {
    const regex = new RegExp(`,?\\s*${country}$`, "i"); // Match the country at the end of the string
    cleanedAddress = cleanedAddress.replace(regex, "");
  });
  
  return cleanedAddress;
}

async function deleteProperty(propertyId) {
  try {
    const response = await fetch('/delete-property', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({        
        propertyId: propertyId,
        userId: userId        
      })
    });

    if (response.ok) {
      console.log('Property deleted successfully!');
    } else {
      const errorData = await response.json();
      console.error('Failed to delete property:', errorData);
    }
  } catch (error) {
    console.error('Error deleting property:', error);
  }
}

  function splitAddress(fullAddress) {
    const parts = fullAddress.split(',');
    if (parts.length < 3) {
      console.error("Invalid address format");
      return null;
    }
    const address = parts[0].trim();
    const city = parts[1].trim();
    const stateZip = parts[2].trim().split(' ');
    const state = stateZip[0];
    const zip = stateZip[1];
    return { address, city, state, zip };
  }

  </script>
</body>
</html>